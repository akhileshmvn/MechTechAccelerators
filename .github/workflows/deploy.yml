name: Build and Deploy to S3

on:
  push:
    branches:
      - main   # runs whenever you push to main branch

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
      API_GATEWAY_NAME: ${{ secrets.API_GATEWAY_NAME }}
      API_STAGE: ${{ secrets.API_STAGE }}

    steps:
      # Step 1: Get your code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # Step 2.5: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install

      # Step 3.5: Push DB schema (only if DATABASE_URL secret is set)
      - name: Push database schema
        if: ${{ env.DATABASE_URL != '' }}
        run: npm run db:push

      # Step 4: Build Vite project
      - name: Build project
        run: npm run build

      # Step 5: Upload dist/ to S3
      - name: Deploy to S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --delete
        env:
          AWS_S3_BUCKET: mechtechaccelerators.com
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_DIR: dist/public

      # Step 6: Deploy API to Lambda (requires LAMBDA_FUNCTION_NAME)
      - name: Package Lambda
        if: ${{ env.LAMBDA_FUNCTION_NAME != '' }}
        run: |
          cd dist
          zip -r lambda.zip lambda.cjs

      - name: Deploy Lambda
        if: ${{ env.LAMBDA_FUNCTION_NAME != '' }}
        run: |
          aws lambda update-function-code \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --zip-file "fileb://dist/lambda.zip" \
            --region "$AWS_REGION"

      - name: Configure Lambda environment
        if: ${{ env.LAMBDA_FUNCTION_NAME != '' && env.DATABASE_URL != '' }}
        run: |
          aws lambda update-function-configuration \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --environment "Variables={DATABASE_URL=$DATABASE_URL}" \
            --region "$AWS_REGION"

      # Step 7: Configure API Gateway HTTP API (optional)
      - name: Configure API Gateway
        if: ${{ env.LAMBDA_FUNCTION_NAME != '' && env.API_GATEWAY_NAME != '' }}
        run: |
          set -euo pipefail
          API_ID=$(aws apigatewayv2 get-apis --query "Items[?Name=='$API_GATEWAY_NAME'].ApiId | [0]" --output text)
          if [ "$API_ID" = "None" ]; then
            API_ID=$(aws apigatewayv2 create-api \
              --name "$API_GATEWAY_NAME" \
              --protocol-type HTTP \
              --query ApiId \
              --output text)
          fi

          LAMBDA_ARN=$(aws lambda get-function --function-name "$LAMBDA_FUNCTION_NAME" --query "Configuration.FunctionArn" --output text)
          INTEGRATION_ID=$(aws apigatewayv2 get-integrations --api-id "$API_ID" --query "Items[?IntegrationUri=='$LAMBDA_ARN'].IntegrationId | [0]" --output text)
          if [ "$INTEGRATION_ID" = "None" ]; then
            INTEGRATION_ID=$(aws apigatewayv2 create-integration \
              --api-id "$API_ID" \
              --integration-type AWS_PROXY \
              --integration-uri "$LAMBDA_ARN" \
              --payload-format-version "2.0" \
              --query IntegrationId \
              --output text)
          fi

          ROUTE_KEY="GET /api/GetCernerCredentials"
          ROUTE_ID=$(aws apigatewayv2 get-routes --api-id "$API_ID" --query "Items[?RouteKey=='$ROUTE_KEY'].RouteId | [0]" --output text)
          if [ "$ROUTE_ID" = "None" ]; then
            aws apigatewayv2 create-route \
              --api-id "$API_ID" \
              --route-key "$ROUTE_KEY" \
              --target "integrations/$INTEGRATION_ID" >/dev/null
          else
            aws apigatewayv2 update-route \
              --api-id "$API_ID" \
              --route-id "$ROUTE_ID" \
              --target "integrations/$INTEGRATION_ID" >/dev/null
          fi

          if [ -z "${API_STAGE:-}" ]; then
            API_STAGE="prod"
          fi
          STAGE_EXISTS=$(aws apigatewayv2 get-stages --api-id "$API_ID" --query "Items[?StageName=='$API_STAGE'].StageName | [0]" --output text)
          if [ "$STAGE_EXISTS" = "None" ]; then
            aws apigatewayv2 create-stage \
              --api-id "$API_ID" \
              --stage-name "$API_STAGE" \
              --auto-deploy >/dev/null
          fi

          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          PERM_ARN="arn:aws:execute-api:$AWS_REGION:$ACCOUNT_ID:$API_ID/*/GET/api/GetCernerCredentials"
          aws lambda add-permission \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --statement-id "apigw-get-cerner-credentials" \
            --action "lambda:InvokeFunction" \
            --principal apigateway.amazonaws.com \
            --source-arn "$PERM_ARN" >/dev/null || true

          API_ENDPOINT=$(aws apigatewayv2 get-api --api-id "$API_ID" --query "ApiEndpoint" --output text)
          echo "API endpoint: $API_ENDPOINT/$API_STAGE/api/GetCernerCredentials"
